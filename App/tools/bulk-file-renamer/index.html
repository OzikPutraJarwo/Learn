<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk File Renamer</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header></header>

    
    <input type="file" id="fileInput" multiple>
    <button id="clearButton">Clear All Files</button>
    
    <h2>Insert Text</h2>
    <input type="text" id="insertText" placeholder="Text to insert">
    <label for="insertPosition">Position:</label>
    <input type="number" id="insertPosition" placeholder="Position (1-based)">
    <select id="insertOption">
        <option value="prefix">Prefix</option>
        <option value="suffix">Suffix</option>
    </select>
    <button id="saveInsertRuleButton">Save Insert Rule</button>
    
    <h2>Remove Text</h2>
    <input type="text" id="removeText" placeholder="Text to remove">
    <label>
        <input type="checkbox" id="caseSensitiveRemove"> Case Sensitive
    </label>
    <button id="saveRemoveRuleButton">Save Remove Rule</button>
    
    <h2>Replace Text</h2>
    <input type="text" id="replaceFrom" placeholder="Text to replace">
    <input type="text" id="replaceTo" placeholder="Replace with">
    <button id="addReplaceRuleButton">Add Replace Rule</button>

    <div class="rules-container">
        <h2>Rules</h2>
        <ul id="rulesList"></ul>
        <button id="removeSelectedRulesButton" style="display: none;">Remove Selected Rules</button>
    </div>

    <button id="downloadButton" style="display: none;">Download Files</button>

    <div class="result">
        <h2>Uploaded Files and Renamed Results</h2>
        <table id="fileTable">
            <thead>
                <tr>
                    <th>Select</th>
                    <th>Original File Name</th>
                    <th>Renamed File Name</th>
                </tr>
            </thead>
            <tbody id="fileTableBody"></tbody>
        </table>
        <button id="removeSelectedButton" style="display: none;">Remove Selected Files</button>
    </div>

    <script>
        let renamedFiles = [];
        let rules = [];

        document.getElementById('fileInput').addEventListener('change', addFiles);
        document.getElementById('clearButton').addEventListener('click', clearAllFiles);
        document.getElementById('saveInsertRuleButton').addEventListener('click', saveInsertRule);
        document.getElementById('saveRemoveRuleButton').addEventListener('click', saveRemoveRule);
        document.getElementById('addReplaceRuleButton').addEventListener('click', addReplaceRule);
        document.getElementById('removeSelectedRulesButton').addEventListener('click', removeSelectedRules);

        function addFiles() {
            const files = document.getElementById('fileInput').files;
            const newFiles = Array.from(files);
            renamedFiles = renamedFiles.concat(newFiles.map(file => ({ name: file.name, originalFile: file })));
            updateFileTable();
        }

        function saveInsertRule() {
            const insertText = document.getElementById('insertText').value;
            const insertPosition = document.getElementById('insertPosition').value;
            const insertOption = document.getElementById('insertOption').value;

            if (insertText) {
                const rule = { type: 'insert', text: insertText, position: parseInt(insertPosition), option: insertOption };
                rules.push(rule);
                updateRulesList();
                document.getElementById('insertText').value = '';
                document.getElementById('insertPosition').value = '';
                updateFileTable();
            } else {
                alert('Please fill in the text to insert.');
            }
        }

        function saveRemoveRule() {
            const removeText = document.getElementById('removeText').value;
            const caseSensitive = document.getElementById('caseSensitiveRemove').checked;

            if (removeText) {
                const rule = { type: 'remove', text: removeText, caseSensitive };
                rules.push(rule);
                updateRulesList();
                document.getElementById('removeText').value = '';
                updateFileTable();
            } else {
                alert('Please fill in the text to remove.');
            }
        }

        function addReplaceRule() {
            const from = document.getElementById('replaceFrom').value;
            const to = document.getElementById('replaceTo').value;

            if (from && to) {
                const rule = { type: 'replace', from, to };
                rules.push(rule);
                updateRulesList();
                document.getElementById('replaceFrom').value = '';
                document.getElementById('replaceTo').value = '';
                updateFileTable();
            } else {
                alert('Please fill in both fields to add a replace rule.');
            }
        }

        function updateRulesList() {
            const rulesList = document.getElementById('rulesList');
            rulesList.innerHTML = ''; // Clear previous rules

            rules.forEach((rule, index) => {
                const listItem = document.createElement('li');
                listItem.textContent = `${rule.type === 'replace' ? 'Replace' : rule.type === 'insert' ? 'Insert' : 'Remove'}: ${rule.from || rule.text || ''} â†’ ${rule.to || ''}`;
                listItem.dataset.index = index;
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                listItem.prepend(checkbox);
                rulesList.appendChild(listItem);
            });

            document.getElementById('removeSelectedRulesButton').style.display = rules.length > 0 ? 'block' : 'none';
        }

        function removeSelectedRules() {
            const selectedCheckboxes = document.querySelectorAll('#rulesList input[type="checkbox"]:checked');
            const indicesToRemove = Array.from(selectedCheckboxes).map(checkbox => {
                const listItem = checkbox.parentElement;
                return parseInt(listItem.dataset.index);
            });

            rules = rules.filter((rule, index) => !indicesToRemove.includes(index));
            updateRulesList();
            updateFileTable();
        }

        function updateFileTable() {
            const tbody = document.getElementById('fileTableBody');
            tbody.innerHTML = ''; // Clear previous results

            renamedFiles.forEach(file => {
                // Ambil nama file dan ekstensi terpisah
                const fileName = file.name.substring(0, file.name.lastIndexOf('.')) || file.name; // Nama tanpa ekstensi
                const fileExt = file.name.substring(file.name.lastIndexOf('.')); // Ekstensi

                let newFileName = fileName; // Mulai dengan nama file tanpa ekstensi

                // Terapkan aturan
                rules.forEach(rule => {
                    if (rule.type === 'insert') {
                        const position = rule.position - 1; // Ubah ke 0-based
                        const words = newFileName.split(' '); // Pisahkan nama file menjadi kata

                        if (rule.option === 'prefix') {
                            if (position >= 0 && position < words.length) {
                                words.splice(position, 0, rule.text); // Sisipkan di posisi yang ditentukan
                            }
                        } else if (rule.option === 'suffix') {
                            if (position >= 0 && position < words.length) {
                                words.splice(words.length - position, 0, rule.text); // Sisipkan sebelum posisi terakhir yang ditentukan
                            }
                        }
                        newFileName = words.join(' '); // Gabungkan kembali menjadi string
                    } else if (rule.type === 'remove') {
                        if (rule.caseSensitive) {
                            newFileName = newFileName.replace(new RegExp(rule.text, 'g'), '');
                        } else {
                            newFileName = newFileName.replace(new RegExp(rule.text, 'gi'), '');
                        }
                    } else if (rule.type === 'replace') {
                        newFileName = newFileName.replace(new RegExp(rule.from, 'g'), rule.to);
                    }
                });

                // Gabungkan nama baru dengan ekstensi
                file.newName = newFileName + fileExt;

                // Tambahkan ke tabel
                const row = tbody.insertRow();
                const selectCell = row.insertCell(0);
                const originalCell = row.insertCell(1);
                const renamedCell = row.insertCell(2);
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                selectCell.appendChild(checkbox);

                originalCell.textContent = file.name;
                renamedCell.textContent = file.newName;
            });

            // Tampilkan tombol unduh jika ada file yang diubah namanya
            document.getElementById('downloadButton').style.display = renamedFiles.length > 0 ? 'block' : 'none';
            document.getElementById('removeSelectedButton').style.display = renamedFiles.length > 0 ? 'block' : 'none';
        }

        function clearAllFiles() {
            renamedFiles = []; // Reset renamed files
            document.getElementById('fileTableBody').innerHTML = ''; // Clear table
            rules = []; // Clear rules
            updateRulesList(); // Clear rules list
            document.getElementById('downloadButton').style.display = 'none'; // Hide download button
            document.getElementById('removeSelectedButton').style.display = 'none'; // Hide remove button
        }

        document.getElementById('removeSelectedButton').onclick = () => {
            const selectedCheckboxes = document.querySelectorAll('#fileTableBody input[type="checkbox"]:checked');
            const filesToRemove = Array.from(selectedCheckboxes).map(checkbox => {
                const row = checkbox.closest('tr');
                const originalFileName = row.cells[1].textContent;
                return renamedFiles.find(file => file.name === originalFileName);
            });

            renamedFiles = renamedFiles.filter(file => !filesToRemove.includes(file));
            updateFileTable();
        };

        document.getElementById('downloadButton').onclick = () => {
            renamedFiles.forEach(file => {
                const blob = new Blob([file.originalFile], { type: file.originalFile.type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = file.newName || file.name; // Gunakan nama baru jika tersedia
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        };
    </script>

</body>
</html>